<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeLapse Converter</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* í—¤ë” */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: -0.5px;
        }

        .header h1 span {
            color: #6366f1;
        }

        .settings-btn {
            background: #1e1e1e;
            border: 1px solid #333;
            color: #aaa;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            border-color: #6366f1;
            color: #6366f1;
        }

        /* ì¹´ë“œ */
        .card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 13px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
        }

        /* ì—…ë¡œë“œ ì˜ì—­ */
        .upload-area {
            border: 2px dashed #333;
            border-radius: 12px;
            padding: 50px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-icon {
            font-size: 40px;
            margin-bottom: 12px;
        }

        .upload-area p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .upload-area p strong {
            color: #6366f1;
        }

        .upload-area.uploaded {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.05);
        }

        /* íŒŒì¼ ì •ë³´ */
        .file-info {
            display: none;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: #222;
            border-radius: 10px;
            margin-top: 16px;
        }

        .file-info.show { display: flex; }

        .file-info-icon { font-size: 24px; }

        .file-info-text { flex: 1; }

        .file-info-name {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 2px;
        }

        .file-info-duration {
            font-size: 12px;
            color: #666;
        }

        /* ë°°ì† ìŠ¬ë¼ì´ë” */
        .speed-section { margin-bottom: 8px; }

        .speed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .speed-label { font-size: 14px; color: #aaa; }

        .speed-badge {
            background: #6366f1;
            color: #fff;
            padding: 4px 14px;
            border-radius: 20px;
            font-size: 15px;
            font-weight: 700;
        }

        .slider-container { position: relative; padding: 8px 0; }

        input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: #333;
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: #6366f1;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(99,102,241,0.2);
            transition: box-shadow 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            box-shadow: 0 0 0 6px rgba(99,102,241,0.3);
        }

        /* ìŠ¬ë¼ì´ë” ëˆˆê¸ˆ ë¼ë²¨ */
        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
        }

        .slider-labels span {
            font-size: 10px;
            color: #444;
        }

        /* ì˜ˆìƒ ê¸¸ì´ í‘œì‹œ */
        .duration-info {
            display: flex;
            gap: 16px;
            margin-top: 20px;
        }

        .duration-box {
            flex: 1;
            background: #222;
            border-radius: 10px;
            padding: 14px 16px;
            text-align: center;
        }

        .duration-box-label {
            font-size: 11px;
            color: #555;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .duration-box-value {
            font-size: 20px;
            font-weight: 700;
            color: #fff;
        }

        .duration-box.output .duration-box-value {
            color: #6366f1;
        }

        /* ë¯¸ë¦¬ë³´ê¸° */
        .preview-section { display: none; }
        .preview-section.show { display: block; }

        .preview-video {
            width: 100%;
            border-radius: 10px;
            background: #000;
            max-height: 400px;
        }

        .preview-note {
            font-size: 12px;
            color: #555;
            margin-top: 8px;
            text-align: center;
        }

        /* ë²„íŠ¼ë“¤ */
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border-radius: 10px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-preview {
            background: #222;
            border: 1px solid #333;
            color: #aaa;
        }

        .btn-preview:hover:not(:disabled) {
            border-color: #6366f1;
            color: #6366f1;
        }

        .btn-convert {
            background: #6366f1;
            color: #fff;
        }

        .btn-convert:hover:not(:disabled) {
            background: #5254cc;
        }

        /* ì§„í–‰ ìƒíƒœ */
        .progress-section {
            display: none;
            margin-top: 16px;
        }

        .progress-section.show { display: block; }

        .progress-bar-wrap {
            background: #222;
            border-radius: 6px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-bar {
            height: 100%;
            background: #6366f1;
            border-radius: 6px;
            width: 0%;
            transition: width 0.3s;
            animation: progressAnim 2s infinite;
        }

        @keyframes progressAnim {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .progress-text {
            font-size: 13px;
            color: #666;
            text-align: center;
        }

        /* ì™„ë£Œ ë©”ì‹œì§€ */
        .success-msg {
            display: none;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 10px;
            padding: 16px;
            margin-top: 16px;
            text-align: center;
        }

        .success-msg.show { display: block; }

        .success-msg p { font-size: 14px; color: #22c55e; }

        .success-msg span { font-size: 12px; color: #555; display: block; margin-top: 4px; }

        /* ì„¤ì • ëª¨ë‹¬ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show { display: flex; }

        .modal {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 32px;
            width: 480px;
            max-width: 90vw;
        }

        .modal h2 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 24px;
        }

        .form-group { margin-bottom: 20px; }

        .form-group label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            background: #222;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px 14px;
            color: #fff;
            font-size: 14px;
            outline: none;
        }

        .form-group input:focus { border-color: #6366f1; }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .btn-cancel {
            background: #222;
            border: 1px solid #333;
            color: #aaa;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-save {
            background: #6366f1;
            border: none;
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
    </style>
</head>
<body>
<div class="container">

    <!-- í—¤ë” -->
    <div class="header">
        <h1>TimeLapse <span>Converter</span></h1>
        <button class="settings-btn" onclick="openSettings()">âš™ï¸ ì„¤ì •</button>
    </div>

    <!-- ì—…ë¡œë“œ ì¹´ë“œ -->
    <div class="card">
        <div class="card-title">ì˜ìƒ ì—…ë¡œë“œ</div>

        <!-- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì—…ë¡œë“œ ì˜ì—­ -->
        <div class="upload-area" id="uploadArea"
             onclick="document.getElementById('fileInput').click()"
             ondragover="handleDragOver(event)"
             ondragleave="handleDragLeave(event)"
             ondrop="handleDrop(event)">
            <div class="upload-icon">ğŸ¬</div>
            <p><strong>í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸</strong>í•˜ì—¬ ì—…ë¡œë“œ</p>
            <p style="margin-top:6px;">MKV, MP4 ì§€ì› Â· ìµœëŒ€ 1ê°œ íŒŒì¼</p>
        </div>

        <!-- ìˆ¨ê²¨ì§„ íŒŒì¼ input -->
        <input type="file" id="fileInput" accept=".mkv,.mp4" style="display:none;"
               onchange="handleFileSelect(event)">

        <!-- ì—…ë¡œë“œëœ íŒŒì¼ ì •ë³´ í‘œì‹œ -->
        <div class="file-info" id="fileInfo">
            <div class="file-info-icon">ğŸ“¹</div>
            <div class="file-info-text">
                <div class="file-info-name" id="fileName">íŒŒì¼ëª…</div>
                <div class="file-info-duration" id="fileDuration">ê¸¸ì´: --</div>
            </div>
        </div>
    </div>

    <!-- ë°°ì† ì„¤ì • ì¹´ë“œ -->
    <div class="card">
        <div class="card-title">ë°°ì† ì„¤ì •</div>

        <div class="speed-section">
            <div class="speed-header">
                <span class="speed-label">ì¬ìƒ ë°°ì†</span>
                <span class="speed-badge" id="speedBadge">x1</span>
            </div>

            <!-- ë°°ì† ìŠ¬ë¼ì´ë” (0~10 = x1~x1024, 2ì˜ ë°°ìˆ˜ ë‹¨ê³„) -->
            <div class="slider-container">
                <input type="range" id="speedSlider" min="0" max="10" step="1" value="0"
                       oninput="handleSpeedChange(this.value)">
            </div>

            <!-- ìŠ¬ë¼ì´ë” ëˆˆê¸ˆ ë¼ë²¨ -->
            <div class="slider-labels">
                <span>x1</span>
                <span>x2</span>
                <span>x4</span>
                <span>x8</span>
                <span>x16</span>
                <span>x32</span>
                <span>x64</span>
                <span>x128</span>
                <span>x256</span>
                <span>x512</span>
                <span>x1024</span>
            </div>
        </div>

        <!-- ì›ë³¸/ì¶œë ¥ ì˜ˆìƒ ê¸¸ì´ í‘œì‹œ -->
        <div class="duration-info">
            <div class="duration-box">
                <div class="duration-box-label">ì›ë³¸ ê¸¸ì´</div>
                <div class="duration-box-value" id="originalDuration">--</div>
            </div>
            <div class="duration-box output">
                <div class="duration-box-label">ì˜ˆìƒ ì¶œë ¥ ê¸¸ì´</div>
                <div class="duration-box-value" id="outputDuration">--</div>
            </div>
        </div>
    </div>

    <!-- ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œ -->
    <div class="card preview-section" id="previewSection">
        <div class="card-title">ë¯¸ë¦¬ë³´ê¸° (ì• 10ì´ˆ ê¸°ì¤€)</div>
        <video class="preview-video" id="previewVideo" controls></video>
        <p class="preview-note" id="previewNote">* ì›ë³¸ ì˜ìƒì˜ ì• 10ì´ˆë¥¼ ì„ íƒí•œ ë°°ì†ìœ¼ë¡œ ì¬ìƒí•©ë‹ˆë‹¤.</p>
    </div>

    <!-- ë³€í™˜ ë²„íŠ¼ ì¹´ë“œ -->
    <div class="card">
        <div class="btn-group">
            <button class="btn btn-preview" id="previewBtn" disabled onclick="generatePreview()">
                ğŸï¸ ë¯¸ë¦¬ë³´ê¸°
            </button>
            <button class="btn btn-convert" id="convertBtn" disabled onclick="startConvert()">
                âš¡ ì €ì¥
            </button>
        </div>

        <!-- ë³€í™˜ ì§„í–‰ í‘œì‹œ -->
        <div class="progress-section" id="progressSection">
            <div class="progress-bar-wrap">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <p class="progress-text" id="progressText">ë³€í™˜ ì¤‘...</p>
        </div>

        <!-- ì™„ë£Œ ë©”ì‹œì§€ -->
        <div class="success-msg" id="successMsg">
            <p>âœ… ë³€í™˜ ì™„ë£Œ!</p>
            <span id="successPath"></span>
        </div>
    </div>

</div>

<!-- ì„¤ì • ëª¨ë‹¬ -->
<div class="modal-overlay" id="modalOverlay" onclick="closeSettingsOutside(event)">
    <div class="modal">
        <h2>âš™ï¸ ì„¤ì •</h2>
        <div class="form-group">
            <label>ì¶œë ¥ íŒŒì¼ ì €ì¥ ê²½ë¡œ</label>
            <input type="text" id="outputPathInput" th:value="${outputPath}"
                   placeholder="ì˜ˆ: C:/timelapse-output">
        </div>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeSettings()">ì·¨ì†Œ</button>
            <button class="btn-save" onclick="saveSettings()">ì €ì¥</button>
        </div>
    </div>
</div>

<script>
    // ë°°ì† ë‹¨ê³„ ë°°ì—´ (2ì˜ ë°°ìˆ˜)
    const speedSteps = [1, 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024];

    // í˜„ì¬ ìƒíƒœ ë³€ìˆ˜
    let currentSpeed = 1;
    let currentFilename = '';
    let originalDurationSec = 0;

    /**
     * ìŠ¬ë¼ì´ë” ê°’ì´ ë³€ê²½ë  ë•Œ í˜¸ì¶œ
     * sliderVal: 0~10 ì •ìˆ˜ â†’ speedSteps ë°°ì—´ë¡œ ì‹¤ì œ ë°°ì† ê³„ì‚°
     */
    function handleSpeedChange(sliderVal) {
        currentSpeed = speedSteps[parseInt(sliderVal)];
        document.getElementById('speedBadge').textContent = 'x' + currentSpeed;

        // íŒŒì¼ì´ ì—…ë¡œë“œëœ ìƒíƒœë¼ë©´ ì˜ˆìƒ ê¸¸ì´ ì—…ë°ì´íŠ¸
        if (originalDurationSec > 0) {
            updateOutputDuration();
        }
    }

    /**
     * ì˜ˆìƒ ì¶œë ¥ ê¸¸ì´ ê³„ì‚° ë° í™”ë©´ í‘œì‹œ
     */
    function updateOutputDuration() {
        const outputSec = originalDurationSec / currentSpeed;
        document.getElementById('outputDuration').textContent = formatDuration(outputSec);
    }

    /**
     * ì´ˆë¥¼ ì‹œ:ë¶„:ì´ˆ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
     */
    function formatDuration(seconds) {
        if (!seconds || seconds <= 0) return '--';
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        if (h > 0) return `${h}ì‹œê°„ ${m}ë¶„ ${s}ì´ˆ`;
        if (m > 0) return `${m}ë¶„ ${s}ì´ˆ`;
        return `${s}ì´ˆ`;
    }

    /**
     * íŒŒì¼ ì„ íƒ ì‹œ í˜¸ì¶œ (input file onchange)
     */
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) uploadFile(file);
    }

    /**
     * ë“œë˜ê·¸ ì˜¤ë²„ ì´ë²¤íŠ¸
     */
    function handleDragOver(event) {
        event.preventDefault();
        document.getElementById('uploadArea').classList.add('dragover');
    }

    /**
     * ë“œë˜ê·¸ ë¦¬ë¸Œ ì´ë²¤íŠ¸
     */
    function handleDragLeave(event) {
        document.getElementById('uploadArea').classList.remove('dragover');
    }

    /**
     * ë“œë¡­ ì´ë²¤íŠ¸ (ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ íŒŒì¼ ì—…ë¡œë“œ)
     */
    function handleDrop(event) {
        event.preventDefault();
        document.getElementById('uploadArea').classList.remove('dragover');
        const file = event.dataTransfer.files[0];
        if (file) uploadFile(file);
    }

    /**
     * ì„œë²„ë¡œ íŒŒì¼ ì—…ë¡œë“œ (FormData ì‚¬ìš©)
     */
    function uploadFile(file) {
        // íŒŒì¼ í˜•ì‹ ì²´í¬
        const ext = file.name.split('.').pop().toLowerCase();
        if (!['mkv', 'mp4'].includes(ext)) {
            alert('MKV ë˜ëŠ” MP4 íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            return;
        }

        currentFilename = file.name;

        // ì—…ë¡œë“œ UI ìƒíƒœ ë³€ê²½
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.innerHTML = '<div class="upload-icon">â³</div><p>ì—…ë¡œë“œ ì¤‘...</p>';

        const formData = new FormData();
        formData.append('file', file);

        // ì„œë²„ë¡œ POST ìš”ì²­
        fetch('/upload', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // ì—…ë¡œë“œ ì„±ê³µ
                    originalDurationSec = data.duration;

                    uploadArea.classList.add('uploaded');
                    uploadArea.innerHTML = '<div class="upload-icon">âœ…</div><p><strong>' + data.filename + '</strong></p><p style="margin-top:6px;">ì—…ë¡œë“œ ì™„ë£Œ</p>';

                    // íŒŒì¼ ì •ë³´ í‘œì‹œ
                    document.getElementById('fileInfo').classList.add('show');
                    document.getElementById('fileName').textContent = data.filename;
                    document.getElementById('fileDuration').textContent = 'ê¸¸ì´: ' + formatDuration(data.duration);
                    document.getElementById('originalDuration').textContent = formatDuration(data.duration);

                    // ì˜ˆìƒ ê¸¸ì´ ì—…ë°ì´íŠ¸
                    updateOutputDuration();

                    // ë²„íŠ¼ í™œì„±í™”
                    document.getElementById('previewBtn').disabled = false;
                    document.getElementById('convertBtn').disabled = false;
                } else {
                    alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + data.message);
                    resetUploadArea();
                }
            })
            .catch(err => {
                alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                resetUploadArea();
            });
    }

    /**
     * ì—…ë¡œë“œ ì˜ì—­ ì´ˆê¸° ìƒíƒœë¡œ ë³µì›
     */
    function resetUploadArea() {
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.classList.remove('uploaded', 'dragover');
        uploadArea.innerHTML = '<div class="upload-icon">ğŸ¬</div><p><strong>í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸</strong>í•˜ì—¬ ì—…ë¡œë“œ</p><p style="margin-top:6px;">MKV, MP4 ì§€ì› Â· ìµœëŒ€ 1ê°œ íŒŒì¼</p>';
    }

    /**
     * ë¯¸ë¦¬ë³´ê¸° ìƒì„± ìš”ì²­ - ì• 10ì´ˆ ì¶”ì¶œ í›„ ë¸Œë¼ìš°ì €ì—ì„œ ë°°ì† ì¬ìƒ
     */
    function generatePreview() {
        document.getElementById('previewBtn').disabled = true;
        document.getElementById('previewBtn').textContent = 'â³ ìƒì„± ì¤‘...';

        fetch('/preview', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const video = document.getElementById('previewVideo');
                    // ë¸Œë¼ìš°ì € ì¬ìƒì†ë„ ìµœëŒ€ 16ë°°ì†ê¹Œì§€ ì§€ì›
                    const browserSpeed = Math.min(currentSpeed, 16);
                    video.src = '/preview/stream?t=' + Date.now();
                    video.onloadedmetadata = function() {
                        video.playbackRate = browserSpeed;
                        video.play();
                    };
                    document.getElementById('previewSection').classList.add('show');

                    // 16ë°°ì† ì´ˆê³¼ ì‹œ ì•ˆë‚´ ë©”ì‹œì§€
                    if (currentSpeed > 16) {
                        document.getElementById('previewNote').textContent =
                            `* ë¸Œë¼ìš°ì € í•œê³„ë¡œ ë¯¸ë¦¬ë³´ê¸°ëŠ” x16ìœ¼ë¡œ ì¬ìƒë©ë‹ˆë‹¤. ì‹¤ì œ ì €ì¥ íŒŒì¼ì€ x${currentSpeed}ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.`;
                    } else {
                        document.getElementById('previewNote').textContent =
                            `* ì›ë³¸ ì˜ìƒì˜ ì• 10ì´ˆë¥¼ x${currentSpeed} ë°°ì†ìœ¼ë¡œ ì¬ìƒ ì¤‘ì…ë‹ˆë‹¤.`;
                    }
                } else {
                    alert('ë¯¸ë¦¬ë³´ê¸° ìƒì„± ì‹¤íŒ¨: ' + data.message);
                }
                document.getElementById('previewBtn').disabled = false;
                document.getElementById('previewBtn').textContent = 'ğŸï¸ ë¯¸ë¦¬ë³´ê¸°';
            })
            .catch(() => {
                alert('ë¯¸ë¦¬ë³´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                document.getElementById('previewBtn').disabled = false;
                document.getElementById('previewBtn').textContent = 'ğŸï¸ ë¯¸ë¦¬ë³´ê¸°';
            });
    }

    /**
     * ìµœì¢… ë³€í™˜ ì‹œì‘ + SSEë¡œ ì§„í–‰ë¥  ì‹¤ì‹œê°„ ìˆ˜ì‹ 
     */
    function startConvert() {
        document.getElementById('convertBtn').disabled = true;
        document.getElementById('previewBtn').disabled = true;
        document.getElementById('progressSection').classList.add('show');
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('progressText').textContent = 'ë³€í™˜ ì¤€ë¹„ ì¤‘...';
        document.getElementById('successMsg').classList.remove('show');

        // ë³€í™˜ ìš”ì²­ (ì„œë²„ì—ì„œ ë³„ë„ ìŠ¤ë ˆë“œë¡œ ë³€í™˜ ì‹œì‘)
        fetch('/convert?speed=' + currentSpeed + '&filename=' + encodeURIComponent(currentFilename), { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    alert('ë³€í™˜ ì‹¤íŒ¨: ' + data.message);
                    document.getElementById('progressSection').classList.remove('show');
                    document.getElementById('convertBtn').disabled = false;
                    document.getElementById('previewBtn').disabled = false;
                    return;
                }

                // SSEë¡œ ì§„í–‰ë¥  ì‹¤ì‹œê°„ ìˆ˜ì‹ 
                const evtSource = new EventSource('/progress');

                evtSource.onmessage = function(e) {
                    const progress = parseInt(e.data);
                    document.getElementById('progressBar').style.width = progress + '%';

                    if (progress < 100) {
                        document.getElementById('progressText').textContent = 'ë³€í™˜ ì¤‘... ' + progress + '%';
                    } else {
                        // ë³€í™˜ ì™„ë£Œ
                        document.getElementById('progressText').textContent = 'ì™„ë£Œ!';
                        evtSource.close();

                        // ì™„ë£Œ í›„ ì¶œë ¥ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
                        fetch('/outputPath')
                            .then(res => res.json())
                            .then(pathData => {
                                document.getElementById('progressSection').classList.remove('show');
                                document.getElementById('successMsg').classList.add('show');
                                document.getElementById('successPath').textContent =
                                    'ì €ì¥ ê²½ë¡œ: ' + pathData.outputPath;
                            });

                        document.getElementById('convertBtn').disabled = false;
                        document.getElementById('previewBtn').disabled = false;
                    }
                };

                evtSource.onerror = function() {
                    evtSource.close();
                    document.getElementById('progressSection').classList.remove('show');
                    document.getElementById('convertBtn').disabled = false;
                    document.getElementById('previewBtn').disabled = false;
                };
            })
            .catch(() => {
                alert('ë³€í™˜ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                document.getElementById('progressSection').classList.remove('show');
                document.getElementById('convertBtn').disabled = false;
                document.getElementById('previewBtn').disabled = false;
            });
    }

    /**
     * ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
     */
    function openSettings() {
        document.getElementById('modalOverlay').classList.add('show');
    }

    /**
     * ì„¤ì • ëª¨ë‹¬ ë‹«ê¸°
     */
    function closeSettings() {
        document.getElementById('modalOverlay').classList.remove('show');
    }

    /**
     * ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
     */
    function closeSettingsOutside(event) {
        if (event.target === document.getElementById('modalOverlay')) {
            closeSettings();
        }
    }

    /**
     * ì„¤ì • ì €ì¥ ìš”ì²­
     */
    function saveSettings() {
        const outputPath = document.getElementById('outputPathInput').value.trim();
        if (!outputPath) {
            alert('ì¶œë ¥ ê²½ë¡œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        fetch('/settings?outputPath=' + encodeURIComponent(outputPath), { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    closeSettings();
                    alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + data.message);
                }
            });
    }
</script>
</body>
</html>